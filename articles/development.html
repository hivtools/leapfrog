<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Developing leapfrog • leapfrog</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Developing leapfrog">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">leapfrog</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.8</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/development.html">Developing leapfrog</a>
    </li>
    <li>
      <a href="../articles/variables.html">Variable naming conventions</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/hivtools/leapfrog/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Developing leapfrog</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/hivtools/leapfrog/blob/main/vignettes/development.Rmd" class="external-link"><code>vignettes/development.Rmd</code></a></small>
      <div class="hidden name"><code>development.Rmd</code></div>

    </div>

    
    
<p>This vignette details how to make changes and add extensions to
leapfrog. There are some organisation and structural things about
leapfrog which were added to enable different researchers to make
extensions to the model. In a way that we can turn these on or off at
run time to run different variants of the model.</p>
<p>The overall aim of this is to allow researchers to write these model
extensions with as little overhead as possible. If you find something
annoying or difficult, let me know and we can probably try and simplify
it. Or at least document it better.</p>
<div class="section level2">
<h2 id="structure">Structure<a class="anchor" aria-label="anchor" href="#structure"></a>
</h2>
<div class="section level3">
<h3 id="model-variants">Model variants<a class="anchor" aria-label="anchor" href="#model-variants"></a>
</h3>
<p>Leapfrog has a set of <code>ModelVariant</code>s which can be run.
See <a href="https://github.com/hivtools/leapfrog/blob/main/cpp_generation/modelSchemas/ModelVariants.json" class="external-link"><code>leapfrog/cpp_generation/modelSchemas/ModelVariants.json</code></a>
for details of these. Each model variant is a collection of boolean
switches or enums. These are used to turn on or off different parts of
the code when it is run, so that leapfrog can have different extensions
and we can compose these together in any way we want. These model
variants are evaluated at compile time. When you compile the code, there
will be an instance in the compiled binary for each variant your code
will call. This will cause the binary to be larger but we chose to do it
this way because we wanted the speed from the compile-time
polymorphism.</p>
<p>All model functions are templated on the model variant, and any
conditional behaviour based upon the model variant should be written as
an <a href="https://www.learncpp.com/cpp-tutorial/constexpr-if-statements/" class="external-link"><code>if constexpr</code></a>.</p>
</div>
<div class="section level3">
<h3 id="model-variants-1">Model variants<a class="anchor" aria-label="anchor" href="#model-variants-1"></a>
</h3>
<p>All model variants are in the <a href="https://github.com/hivtools/leapfrog/tree/main/leapfrogr/inst/include/models" class="external-link"><code>models</code>
directory</a>. Every model variant should be created as a struct. We can
use the struct to alias state space variables or bits of the config to
make the code more easily readable. The struct should expose at least
one public function which can then be called from the <a href="https://github.com/hivtools/leapfrog/blob/aa72a70ea4705489325185409223ddfc4aad75ef/leapfrogr/inst/include/leapfrog.hpp#L116" class="external-link"><code>project_year</code></a>
function.</p>
<p>To explain what is going on in the model struct we can look at the <a href="https://github.com/hivtools/leapfrog/blob/aa72a70ea4705489325185409223ddfc4aad75ef/leapfrogr/inst/include/models/adult_hiv_model_simulation.hpp" class="external-link">adult
HIV model as an example</a></p>
<ul>
<li>
<a href="https://github.com/hivtools/leapfrog/blob/aa72a70ea4705489325185409223ddfc4aad75ef/leapfrogr/inst/include/models/adult_hiv_model_simulation.hpp#L9-L18" class="external-link">Templating
on <code>Config</code></a> - this is used to ensure that the code is not
compiled when we’re running a variant in which it is disabled.</li>
<li>We <a href="https://github.com/hivtools/leapfrog/blob/aa72a70ea4705489325185409223ddfc4aad75ef/leapfrogr/inst/include/models/adult_hiv_model_simulation.hpp#L19-43" class="external-link">alias
parts of the config and define private state space variables</a> so we
do not need to use fully qualified names later in the code and can
instead use the shorthand for readability.</li>
<li>We <a href="https://github.com/hivtools/leapfrog/blob/aa72a70ea4705489325185409223ddfc4aad75ef/leapfrogr/inst/include/models/adult_hiv_model_simulation.hpp#L46-62" class="external-link">define
args as part of the struct constructor</a> these hold the actual runtime
data such has
<ul>
<li>
<code>t</code> - the current time step of the model as an index,
e.g. if running for 1970:2030, this will start at <code>1</code> and
loop to <code>61</code>. Any input data you read based on time step
index should have <code>1970</code> at the first index. Index
<code>1</code> in R and <code>0</code> in C++.</li>
<li>
<code>pars</code> - the parameters for this model, these are
read-only values</li>
<li>
<code>state_curr</code> - the state at the current point in time.
This is read-only.</li>
<li>
<code>state_next</code> - the state at the next time point. This is
what we are currently populating from the previous time step and the
parameters.</li>
<li>
<code>intermediate</code> - a place for storing any data used within
a single time step. Use this as to store intermediate values for use
later in your code. This is reset to all 0s at the end of every time
step.</li>
</ul>
</li>
<li>One or more <a href="https://github.com/hivtools/leapfrog/blob/aa72a70ea4705489325185409223ddfc4aad75ef/leapfrogr/inst/include/models/adult_hiv_model_simulation.hpp#L64" class="external-link">public
functions</a> that we can call from <code>project_year</code>
</li>
<li>Zero or more <a href="https://github.com/hivtools/leapfrog/blob/aa72a70ea4705489325185409223ddfc4aad75ef/leapfrogr/inst/include/models/adult_hiv_model_simulation.hpp#L110" class="external-link">private
functions</a> these do the actual work of the model and will never be
called from outside the struct. You can create as many or as few as you
want, they should be used to organise different parts of the model code
as needed.</li>
</ul>
<p>Note that after each time step the code will do the following</p>
<ul>
<li>Optionally save out the state see <a href="#state-saving">State
saving</a> section.</li>
<li>Replace <code>state_curr</code> with <code>state_next</code>.</li>
<li>Set new <code>state_next</code> to all 0s.</li>
<li>Set <code>intermediate</code> to all 0s.</li>
</ul>
</div>
<div class="section level3">
<h3 id="state-saving">State saving<a class="anchor" aria-label="anchor" href="#state-saving"></a>
</h3>
<p>Leapfrog runs a top-level loop over the time step. At the end of each
time step, the state is optionally saved out and eventually returned. We
do it this way because it decouples the reporting of the model and each
time step iteration. When you run the model with <code>run_model</code>
you can specify which years you want to output data for. By default it
will output for all time steps, but if say you are only interested in
the last time step. You can return this by running e.g.</p>
<pre><code><span><span class="fu"><a href="../reference/run_model.html">run_model</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">parameters</span>, <span class="fl">1970</span><span class="op">:</span><span class="fl">2030</span>, <span class="fl">10</span>, <span class="fl">2030</span><span class="op">)</span></span></code></pre>
<p>This time output is managed by the internal <code>OutputState</code>
struct see e.g. <a href="https://github.com/hivtools/leapfrog/blob/aa72a70ea4705489325185409223ddfc4aad75ef/leapfrogr/inst/include/leapfrog.hpp#L110" class="external-link"><code>leapfrogr/inst/include/leapfrog.hpp</code></a></p>
</div>
</div>
<div class="section level2">
<h2 id="modifying-config-to-add-new-input-output-or-intermediate-data">Modifying config to add new input, output or intermediate data<a class="anchor" aria-label="anchor" href="#modifying-config-to-add-new-input-output-or-intermediate-data"></a>
</h2>
<p>Leapfrog uses code generation to write the code for wiring up the
input and output data. This is to reduce the number of locations you
need to make changes when you add new input data or return new data from
the model. In short it amounts to updating one of the configs at <a href="https://github.com/hivtools/leapfrog/blob/main/cpp_generation/modelSchemas/configs" class="external-link"><code>leapfrogr/inst/cpp_generation/modelSchemas/configs</code></a>
and running <a href="https://github.com/hivtools/leapfrog/blob/main/scripts/generate" class="external-link"><code>scripts/generate</code></a></p>
<div class="section level3">
<h3 id="config-structure">Config structure<a class="anchor" aria-label="anchor" href="#config-structure"></a>
</h3>
<p>The config is JSON, it has the following sections:</p>
<ol style="list-style-type: decimal">
<li>
<code>name</code> - The name of this model variant type, it should
be short. It is used in C++ code for the type which holds the state
space, input data, intermediate data and output data associated with
this variant.</li>
<li>
<code>long_name</code> - A long name for the model variant, at the
moment used on for Delphi interface (to distinguish between 2 digit
module codes used by Avenir internally)</li>
<li>
<code>namespace</code> - The name of an instance of the model
variant, used in C++ code.</li>
<li>
<code>enable_if</code> - A conditional for when the model variant
should be active. This is a compile time conditional based on model
variant booleans. When the condition is true, the input data must be
supplied and output data will be returned.</li>
<li>
<code>state_space</code> - An object containing named integers.
These are the dimensions for the statically allocated input,
intermediate and output data. A variant can use state space parameters
from other variants.</li>
<li>
<code>pars</code> - The inputs to the model used in this variant.
You can use parameters supplied by other variants. Each parameter can
define:
<ol style="list-style-type: decimal">
<li>A “num_type” which should be “int” or “real_type”. “real_type” is
used by TMB but for normal running is just a <code>double</code>.</li>
<li>(optionally) “dims” - which is an array of sizes, it can use values
from the state space, options or expressions
e.g. <code>opts.proj_steps * opts.hts_per_year</code>. If no “dims” are
set, assumed this is a scalar value.</li>
<li>(optionally) “alias” - a named list of aliases for the different
language interfaces, at the moment only “r” is used and should be
removed in the future. This should not be used for new parameters.</li>
</ol>
</li>
<li>
<code>intermediate</code> - use to define any intermediate bits of
data used during the model run. We define them here because then they
can be statically allocated instead of allocated every iteration of the
time loop. These are automatically set to 0 at the end of every time
step. Each piece of intermediate data needs a “num_type” and
“dims”.</li>
<li>
<code>state</code> - data output from the model. Defined as a JSON
object, these are the results filled in during a model run. Each item
needs a “num_type” and (optionally) “dims”. When a model is run the
output is a named list/dictionary with keys matching from the JSON
object and values corresponding to the “dims” with an additional time
dimension. So if the state defines <code>p_totpop</code> with dims
<code>["SS::pAG", "SS::NS"]</code> the output will have
<code>p_totpop</code> with 3 dimensions of lengths pAG, NS and number of
output years.</li>
</ol>
<p>After making changes to the <a href="https://github.com/hivtools/leapfrog/blob/main/cpp_generation/modelSchemas/configs" class="external-link">config</a>,
run the generate script <a href="https://github.com/hivtools/leapfrog/blob/main/scripts/generate" class="external-link"><code>scripts/generate</code></a>.
Note that this will update several of the generated files. The generated
files should never be manually changed as the generate script will
completely rewrite it.</p>
<p>After regenerating the code, rebuild the project and you are ready to
use the new input data in C++.</p>
</div>
</div>
<div class="section level2">
<h2 id="adding-a-new-model-variant">Adding a new model variant<a class="anchor" aria-label="anchor" href="#adding-a-new-model-variant"></a>
</h2>
<p>There are two types of model variants at the moment:</p>
<ol style="list-style-type: decimal">
<li>A flag which turns a section of code on or off, this will come with
additional model inputs and outputs</li>
<li>A flag which changes the dimensions of some model input or
outputs</li>
</ol>
<p>The required changes will be different depending on if your new
variant is one of the first types, which brings additional input/output
or the second type which does not bring additional data.</p>
<p>To add a new variant. Firstly, in the code generation:</p>
<ol style="list-style-type: decimal">
<li>Add a new flag and variant in <a href="https://github.com/hivtools/leapfrog/blob/aa72a70ea4705489325185409223ddfc4aad75ef/cpp_generation/modelSchemas/ModelVariants.json" class="external-link"><code>cpp_generation/modelSchemas/ModelVariants.json</code></a>.
Make sure the new flag is set to true or false in all other model
variants.</li>
<li>If you have new input data or output data for this variant, add a
new config file in the <a href="https://github.com/hivtools/leapfrog/blob/main/cpp_generation/modelSchemas/configs" class="external-link"><code>configs dir</code></a>
and fill in the details as required</li>
<li>Run the generate script</li>
</ol>
<p>In the C++ code:</p>
<ol style="list-style-type: decimal">
<li>
<p>Add new model code for your variant. At this point I would just
add a skeleton with a print line to check your set up works, and fill in
actual model code later. Model code should go <a href="https://github.com/hivtools/leapfrog/tree/main/leapfrogr/inst/include/models" class="external-link">here</a>.
You can use the following snippet as a template</p>
<pre><code>#pragma once

#include "../options.hpp"
#include "../generated/config_mixer.hpp"

namespace leapfrog {
namespace internal {

// model_variant_flag1 &amp; 2 need to be in pascal case, can do one of multiple model variant flags required for this model
template&lt;typename Config&gt;
concept {{ model_name }}Enabled = {{ model_variant_flag1 }}&lt;Config&gt; &amp;&amp; {{ model_variant_flag2 }}&lt;Config&gt;;

template&lt;typename Config&gt;
struct {{ model_name }} {
  {{ model_name }}(...) {};
};

template&lt;{{ model_name }}Enabled Config&gt;
struct {{ model_name }}&lt;Config&gt; {
  using real_type = typename Config::real_type;
  using ModelVariant = typename Config::ModelVariant;
  using SS = Config::SS;
  using Pars = Config::Pars;
  using State = Config::State;
  using Intermediate = Config::Intermediate;
  using Args = Config::Args;

  // function args
  int t;
  const Pars&amp; pars;
  const State&amp; state_curr;
  State&amp; state_next;
  Intermediate&amp; intermediate;
  const Options&lt;real_type&gt;&amp; opts;

  // only exposing the constructor and some methods
  public:
  {{ model_name }}(Args&amp; args):
    t(args.t),
    pars(args.pars),
    state_curr(args.state_curr),
    state_next(args.state_next),
    intermediate(args.intermediate),
    opts(args.opts)
  {};

  void run() { std::cout &lt;&lt; "Running new model\n" };
};</code></pre>
</li>
<li><p>Call your new model variant at the appropriate point in the <a href="https://github.com/hivtools/leapfrog/blob/aa72a70ea4705489325185409223ddfc4aad75ef/leapfrogr/inst/include/leapfrog.hpp#L116" class="external-link"><code>project_year</code>
function</a></p></li>
</ol>
<p>You now need to update the wrappers you want to expose the model
variant to. For the R wrapper:</p>
<ol style="list-style-type: decimal">
<li>Add the variant in the available <a href="https://github.com/hivtools/leapfrog/blob/aa72a70ea4705489325185409223ddfc4aad75ef/leapfrogr/src/leapfrog.cpp#L15" class="external-link">model
configurations</a>.</li>
<li>Add mapping from the string to the model variant struct in Rcpp
wrapper code in <a href="https://github.com/hivtools/leapfrog/blob/aa72a70ea4705489325185409223ddfc4aad75ef/leapfrogr/src/leapfrog.cpp#L133" class="external-link"><code>src/leapfrog.cpp</code></a>.</li>
<li>Add a mapping from the string to the model variant struct in <a href="https://github.com/hivtools/leapfrog/blob/main/leapfrogr/src/leapfrog.cpp#L203" class="external-link">get_leapfrog_ss
function</a>.</li>
<li>Add a test which calls your new model variant, to make sure
everything is wired up correctly.</li>
</ol>
<p>For the Python wrapper:</p>
<ol style="list-style-type: decimal">
<li>Add the variant in the available <a href="https://github.com/hivtools/leapfrog/blob/aa72a70ea4705489325185409223ddfc4aad75ef/leapfrog-py/src/main.cpp#L103" class="external-link">model
configurations</a>.</li>
<li>Add mapping from the string to the model variant struct in the <a href="https://github.com/hivtools/leapfrog/blob/aa72a70ea4705489325185409223ddfc4aad75ef/leapfrog-py/src/main.cpp#L114" class="external-link">wrapper
code</a>.</li>
<li>Add a mapping fromt he string to the model variant struct in the <a href="https://github.com/hivtools/leapfrog/blob/aa72a70ea4705489325185409223ddfc4aad75ef/leapfrog-py/src/main.cpp#L173" class="external-link">get_leapfrog_ss
function</a>.</li>
</ol>
<p>The C/Delphi interface and C++ interface have more specific usages so
we probably don’t need to expose new variants via these interfaces. But
if we do, speak to Rob for help with how to do this.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Jeffrey Imai-Eaton, Magdalene Walters, Robert Ashton, Mantra Kusumgar.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
